name: ðŸ“š Generate and Deploy Documentation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ›´æ–°æ–‡æ¡£
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™ä»¥ä¾¿éƒ¨ç½²åˆ°GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿è¡Œçš„éƒ¨ç½²ä¹‹é—´çš„æŽ’é˜Ÿè¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æž„å»ºæ–‡æ¡£
  build-docs:
    name: ðŸ”§ Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ä»¥ä¾¿ç”Ÿæˆæ›´å¥½çš„æ–‡æ¡£
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ðŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || echo "requirements.txt not found, skipping..."
        pip install matplotlib seaborn pandas numpy  # ç”¨äºŽç¤ºä¾‹å’Œæµ‹è¯•
    
    - name: ðŸ”§ Install Doxygen
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
        doxygen --version
    
    - name: ðŸ“Š Install Documentation Dependencies
      run: |
        pip install markdown beautifulsoup4 lxml
    
    - name: ðŸ—ï¸ Generate Documentation
      run: |
        echo "Starting documentation generation..."
        
        # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
        chmod +x docs/generate_docs.py
        
        # è¿è¡Œæ–‡æ¡£ç”Ÿæˆè„šæœ¬
        python docs/generate_docs.py --verbose
        
        # æ£€æŸ¥ç”Ÿæˆç»“æžœ
        if [ -d "docs/generated/html" ]; then
          echo "âœ… Documentation generated successfully"
          ls -la docs/generated/html/
        else
          echo "âŒ Documentation generation failed"
          exit 1
        fi
    
    - name: ðŸ“ Create Index Redirect
      run: |
        # åˆ›å»ºæ ¹ç›®å½•çš„index.htmlé‡å®šå‘åˆ°æ–‡æ¡£
        cat > docs/generated/html/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0; url=./html/index.html">
            <title>NeuroExapt Documentation</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    text-align: center;
                }
                .container {
                    padding: 40px;
                    border-radius: 15px;
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(10px);
                }
                .spinner {
                    margin: 20px auto;
                    width: 40px;
                    height: 40px;
                    border: 4px solid rgba(255,255,255,0.3);
                    border-top: 4px solid white;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ðŸ§  NeuroExapt Documentation</h1>
                <div class="spinner"></div>
                <p>Redirecting to documentation...</p>
                <p><a href="./html/index.html" style="color: white;">Click here if not redirected automatically</a></p>
            </div>
        </body>
        </html>
        EOF
    
    - name: ðŸ“‹ Generate Documentation Report
      run: |
        # ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡æŠ¥å‘Š
        cat > docs/generated/build-report.md << EOF
        # Documentation Build Report
        
        **Build Date:** $(date)
        **Build Trigger:** ${{ github.event_name }}
        **Commit:** ${{ github.sha }}
        **Branch:** ${{ github.ref_name }}
        
        ## Generated Files
        \`\`\`
        $(find docs/generated -name "*.html" | wc -l) HTML files
        $(find docs/generated -name "*.css" | wc -l) CSS files
        $(find docs/generated -name "*.js" | wc -l) JavaScript files
        $(find . -name "*.md" | wc -l) Markdown files in project
        \`\`\`
        
        ## Documentation Structure
        \`\`\`
        $(tree docs/generated/html -L 2 || ls -la docs/generated/html/)
        \`\`\`
        
        ## Build Status
        âœ… Documentation build completed successfully
        EOF
    
    - name: ðŸ” Validate Documentation
      run: |
        # åŸºæœ¬éªŒè¯æ£€æŸ¥
        echo "ðŸ” Validating generated documentation..."
        
        # æ£€æŸ¥ä¸»è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        required_files=(
          "docs/generated/html/index.html"
          "docs/generated/html/modules.html"
          "docs/generated/html/files.html"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
        # æ£€æŸ¥æ–‡æ¡£å¤§å°
        doc_size=$(du -sh docs/generated/html | cut -f1)
        echo "ðŸ“Š Documentation size: $doc_size"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰JavaScripté”™è¯¯ï¼ˆåŸºæœ¬è¯­æ³•æ£€æŸ¥ï¼‰
        find docs/generated/html -name "*.js" -exec node -c {} \; 2>/dev/null || echo "âš ï¸ JavaScript validation skipped (Node.js not available)"
    
    - name: ðŸ“¤ Upload Documentation Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neuroexapt-docs-${{ github.sha }}
        path: docs/generated/html/
        retention-days: 30
    
    - name: ðŸ“„ Upload Pages Artifact
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/generated/html/

  # éƒ¨ç½²åˆ°GitHub Pages (ä»…åœ¨ä¸»åˆ†æ”¯)
  deploy-pages:
    name: ðŸš€ Deploy to GitHub Pages
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    needs: build-docs
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ðŸŒ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: ðŸ“¢ Post Deployment Info
      run: |
        echo "ðŸŽ‰ Documentation deployed successfully!"
        echo "ðŸ“– Documentation URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ðŸ”— Direct link will be available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

  # é€šçŸ¥æž„å»ºç»“æžœ
  notify:
    name: ðŸ“¢ Notify Build Status
    if: always()
    needs: [build-docs, deploy-pages]
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“Š Create Build Summary
      run: |
        echo "## ðŸ“š Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-docs.result }}" == "success" ]; then
          echo "âœ… **Documentation Build:** SUCCESS" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Documentation Build:** FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
          if [ "${{ needs.deploy-pages.result }}" == "success" ]; then
            echo "ðŸš€ **GitHub Pages Deployment:** SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“– **Documentation is now available at:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **GitHub Pages Deployment:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â­ï¸ **GitHub Pages Deployment:** SKIPPED (not main branch)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“Š Build Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ”§ Workflow File](.github/workflows/docs.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“ Documentation Source](docs/)" >> $GITHUB_STEP_SUMMARY